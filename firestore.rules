rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- 基本関数 ---
    function isSignedIn() { return request.auth != null; }
    function isSuperAdmin() { return request.auth.uid == 'GLGPpy6IlyWbGw15OwBPzRdCPZI2'; }
    function isOwner(userId) { return request.auth.uid == userId; }

    // --- バリデーション関数 ---
    function isValidString(text, max) {
      return text is string && text.size() <= max;
    }

    function isValidUrl(url) {
      return url == null || url == '' || (
        url is string 
        && url.size() <= 2000 
        && url.matches('^https://firebasestorage\\.googleapis\\.com/.*')
      );
    }

    function isValidTitleCheck(data) {
      return ('eventConfig' in data && data.eventConfig is map)
          && ('title' in data.eventConfig && data.eventConfig.title is string)
          && (data.eventConfig.title.size() <= 100);
    }

    function isValidTimetableItem(item) {
      return ('name' in item && item.name is string && item.name.size() <= 100)
          && ('duration' in item && (item.duration is number || item.duration is string))
          && (!('imageUrl' in item) || isValidUrl(item.imageUrl));
    }

    function isValidListCheck(listData) {
      return listData is list 
          && listData.size() <= 100
          && (listData.size() == 0 || isValidTimetableItem(listData[0]));
    }

    function isValidTimetableCheck(data) {
      return (!('timetable' in data) || isValidListCheck(data.timetable))
          && (!('vjTimetable' in data) || isValidListCheck(data.vjTimetable));
    }

    function isValidFloorItem(floorData) {
      return 'name' in floorData && floorData.name is string && floorData.name.size() <= 50;
    }

    function isValidFloorsCheck(data) {
      return !('floors' in data) || (
        data.floors is map
        && data.floors.size() <= 20
        && (data.floors.size() == 0 || isValidFloorItem(data.floors.values()[0]))
      );
    }

    function isValidUserProfile(data) {
      return (!('displayName' in data) || isValidString(data.displayName, 100))
          && (!('email' in data) || data.email == null || isValidString(data.email, 100));
    }

    function isValidUserCreate(data) {
      return (!('role' in data) || data.role == 'free')
          && (!('isManuallyGranted' in data) || data.isManuallyGranted == false)
          && isValidUserProfile(data);
    }
    function isValidUserUpdate(newData, oldData) {
      return (!('role' in newData) || newData.role == oldData.role)
          && (!('isManuallyGranted' in newData) || newData.isManuallyGranted == oldData.isManuallyGranted)
          && isValidUserProfile(newData);
    }

    // --- コレクションルール ---

    match /timetables/{eventId} {
      allow get: if true;
      
      // ★修正: listルールを resource.data ベースに変更（より確実な判定）
      allow list: if isSignedIn() && (
        resource.data.ownerUid == request.auth.uid || isSuperAdmin()
      );

      allow create: if isSuperAdmin() || (
        isSignedIn() 
        && request.resource.data.ownerUid == request.auth.uid
        && isValidTitleCheck(request.resource.data)
        && isValidTimetableCheck(request.resource.data)
        && isValidFloorsCheck(request.resource.data)
      );
      allow update: if isSuperAdmin() || (
        isSignedIn() 
        && isOwner(resource.data.ownerUid)
        && isValidTitleCheck(request.resource.data)
        && isValidTimetableCheck(request.resource.data)
        && isValidFloorsCheck(request.resource.data)
      );
      
      // ★修正: 削除済みドキュメント(resource == null)のエラー回避を追加
      allow delete: if isSignedIn() && (
        resource == null || isOwner(resource.data.ownerUid) || isSuperAdmin()
      );
    }

    match /users/{userId} {
      allow get: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      allow list: if isSuperAdmin();
      allow create: if isSuperAdmin() || (isSignedIn() && isOwner(userId) && isValidUserCreate(request.resource.data));
      allow update: if isSuperAdmin() || (isSignedIn() && isOwner(userId) && isValidUserUpdate(request.resource.data, resource.data));
      
      // アカウント削除用
      allow delete: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
    }
  }
}