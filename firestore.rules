rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- 基本関数 ---
    function isSignedIn() { return request.auth != null; }
    function isSuperAdmin() { return request.auth.uid == 'GLGPpy6IlyWbGw15OwBPzRdCPZI2'; }
    function isOwner(userId) { return request.auth.uid == userId; }

    // --- バリデーション関数 (緩和版) ---
    function isValidString(text, max) {
      // ★緩和: nullも許容
      return text == null || (text is string && text.size() <= max);
    }

    function isValidUrl(url) {
      // ★緩和: URLチェックは形式までは問わない（空文字等は許容）
      return url == null || url == '' || (
        url is string 
        && url.size() <= 2000 
      );
    }

    function isValidTitleCheck(data) {
      // ★緩和: 項目がなくてもOKにする
      return !('eventConfig' in data) || (
          data.eventConfig is map
          && (!('title' in data.eventConfig) || isValidString(data.eventConfig.title, 100))
      );
    }

    function isValidTimetableItem(item) {
      return item is map
          && (!('name' in item) || isValidString(item.name, 100))
          && (!('duration' in item) || item.duration is number || item.duration is string)
          && (!('imageUrl' in item) || isValidUrl(item.imageUrl));
    }

    function isValidListCheck(listData) {
      // ★緩和: サイズチェックのみ
      return listData is list && listData.size() <= 100;
    }

    function isValidTimetableCheck(data) {
      return (!('timetable' in data) || isValidListCheck(data.timetable))
          && (!('vjTimetable' in data) || isValidListCheck(data.vjTimetable));
    }

    function isValidFloorItem(floorData) {
      return floorData is map 
          && (!('name' in floorData) || isValidString(floorData.name, 50));
    }

    function isValidFloorsCheck(data) {
      return !('floors' in data) || (
        data.floors is map
        && data.floors.size() <= 20
      );
    }

    function isValidUserProfile(data) {
      return (!('displayName' in data) || isValidString(data.displayName, 100))
          && (!('email' in data) || isValidString(data.email, 100));
    }

    function isValidUserCreate(data) {
      return (!('role' in data) || data.role == 'free')
          && (!('isManuallyGranted' in data) || data.isManuallyGranted == false)
          && isValidUserProfile(data);
    }
    
    function isValidUserUpdate(newData, oldData) {
      return (!('role' in newData) || newData.role == oldData.role)
          && (!('isManuallyGranted' in newData) || newData.isManuallyGranted == oldData.isManuallyGranted)
          && isValidUserProfile(newData);
    }

    // --- コレクションルール ---

    match /timetables/{eventId} {
      allow get: if true;
      
      // ★最新版の維持: listルール (resource.data ベース)
      allow list: if isSignedIn() && (
        resource.data.ownerUid == request.auth.uid || isSuperAdmin()
      );

      // Create時はある程度チェックを入れる（緩和版バリデーションを使用）
      allow create: if isSuperAdmin() || (
        isSignedIn() 
        && request.resource.data.ownerUid == request.auth.uid
        && isValidTitleCheck(request.resource.data)
        && isValidTimetableCheck(request.resource.data)
        && isValidFloorsCheck(request.resource.data)
      );
      
      // ★緩和: update時は所有者チェックのみ（バリデーション除外）
      // これにより、部分更新やクライアント側サニタイズ済みのデータ保存がスムーズになります
      allow update: if isSuperAdmin() || (
        isSignedIn() 
        && isOwner(resource.data.ownerUid)
      );
      
      // ★最新版の維持: deleteルール (resource == null 対応)
      allow delete: if isSignedIn() && (
        resource == null || isOwner(resource.data.ownerUid) || isSuperAdmin()
      );
    }

    match /users/{userId} {
      allow get: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      allow list: if isSuperAdmin();
      allow create: if isSuperAdmin() || (isSignedIn() && isOwner(userId) && isValidUserCreate(request.resource.data));
      allow update: if isSuperAdmin() || (isSignedIn() && isOwner(userId) && isValidUserUpdate(request.resource.data, resource.data));
      
      // アカウント削除用
      allow delete: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
    }
  }
}