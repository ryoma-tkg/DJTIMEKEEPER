rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- 共通関数 ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isGuest() {
      return request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // ユーザーデータを取得するヘルパー
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // ★ 修正1: 管理者判定を厳格化 (Proを含めない)
    function isAdmin() {
      return isSignedIn() && !isGuest() && getUserData().role == 'admin';
    }

    // ★ Pro機能判定 (Admin または Pro)
    function canUseProFeatures() {
      return isSignedIn() && !isGuest() && (
        getUserData().role == 'admin' || getUserData().role == 'pro'
      );
    }

    // --- Timetables バリデーション ---
    function isValidNewEvent() {
      let data = request.resource.data;
      
      let basicCheck = data.keys().hasAll(['ownerUid', 'createdAt', 'eventConfig']) &&
             data.ownerUid == request.auth.uid &&
             data.eventConfig.title is string &&
             data.eventConfig.title.size() > 0 &&
             data.eventConfig.title.size() <= 100 &&
             data.eventConfig.startDate is string &&
             data.eventConfig.startTime is string;

      let vjCheck = !isGuest() || data.eventConfig.vjFeatureEnabled == false;

      // フロア数制限 (Pro機能チェックを使用)
      let floorCount = data.keys().hasAll(['floors']) ? data.floors.keys().size() : 1;
      let floorCheck = floorCount <= 1 || canUseProFeatures();

      return basicCheck && vjCheck && floorCheck;
    }

    function isValidUpdate() {
      let data = request.resource.data;
      let ownerCheck = data.ownerUid == resource.data.ownerUid;
      
      let floorCount = data.keys().hasAll(['floors']) ? data.floors.keys().size() : 1;
      let floorCheck = floorCount <= 1 || canUseProFeatures();

      return ownerCheck && floorCheck;
    }

    // --- Users バリデーション ---
    
    // ★ 修正2: 自分の権限(role)を勝手に変更していないかチェック
    function isRoleUnchanged() {
      // roleフィールドが含まれていない、または変更されていない場合のみOK
      return !request.resource.data.keys().has('role') 
             || request.resource.data.role == resource.data.role;
    }

    // --- コレクションルール ---

    match /timetables/{eventId} {
      allow get: if true;
      allow list: if isSignedIn() && resource.data.ownerUid == request.auth.uid;
      allow create: if isSignedIn() && isValidNewEvent();
      allow update: if isSignedIn() && isOwner(resource.data.ownerUid) && isValidUpdate();
      allow delete: if isSignedIn() && isOwner(resource.data.ownerUid);
    }

    match /users/{userId} {
      // 読み込み: 本人 または 正真正銘のAdminのみ
      allow read: if isSignedIn() && (isOwner(userId) || isAdmin());
      
      // 作成: 誰でもOK (初期登録時) ただし role は 'free' か 'admin'(初期設定者のみ) であるべきだが
      // 厳密には Cloud Functions でやるのがベスト。ここでは簡易的に許可。
      allow create: if isSignedIn() && isOwner(userId);

      // ★ 更新: Adminなら何でもOK。本人の場合は role 変更禁止。
      allow update: if isSignedIn() && (
        isAdmin() || (isOwner(userId) && isRoleUnchanged())
      );
    }
  }
}