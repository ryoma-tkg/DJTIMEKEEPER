// [ryoma-tkg/djtimekeeper/DJTIMEKEEPER-phase3-dev/firestore.rules]
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // 'timetables' コレクション
    match /timetables/{eventId} {
      
      // --- 読み取り(Read) ---
      
      // 1. 【/live/:eventId】 (LivePage)
      //    単一ドキュメントの取得(get)は、誰でも許可する。
      allow get: if true;
      
      // 2. 【/ (DashboardPage)】
      //    一覧の取得(list)は、ログイン中(auth.uid != null)であれば許可する。
      //    ※「どのイベントを読み込むか」は、インデックスを使って
      //    ※ クライアント側 (DashboardPage.jsx) のクエリを信頼する。
      allow list: if request.auth.uid != null;

      // --- 書き込み(Write) ---
      
      // 1. 【新規作成 (create)】
      //    ログイン中かつ、作成データの ownerUid が自分自身であること。
      allow create: if request.auth.uid != null
                    && request.resource.data.ownerUid == request.auth.uid;
      
      // 2. 【更新・削除 (update, delete)】
      //    ログイン中かつ、"既に"データベースにあるデータの ownerUid が自分自身であること。
      allow update, delete: if request.auth.uid != null
                            && resource.data.ownerUid == request.auth.uid;
    }
  }
}